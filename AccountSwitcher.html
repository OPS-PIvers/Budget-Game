<!-- AccountSwitcher.html - Reusable Account Switcher Component -->
<div class="account-switcher" id="account-switcher">
  <button
    class="account-avatar"
    id="account-avatar"
    aria-label="Account menu"
    aria-haspopup="true"
    aria-expanded="false"
    tabindex="0"
  >
    <span id="account-initials">?</span>
  </button>

  <div class="account-menu" id="account-menu" role="menu" aria-label="Account options">
    <div class="account-menu-header">
      <div class="account-email" id="account-email">Loading...</div>
      <div class="account-name" id="account-name">Please wait</div>
    </div>
    <div class="account-menu-actions">
      <button class="account-menu-item" onclick="switchAccount()" role="menuitem">
        <svg viewBox="0 0 24 24">
          <path d="M16 17v2H2v-2s0-4 7-4 7 4 7 4m-3.5-9.5A3.5 3.5 0 1 0 9 11a3.5 3.5 0 0 0 3.5-3.5m3.44 5.5A5.32 5.32 0 0 1 18 17v2h4v-2s0-3.63-6.06-4M15 4a3.4 3.4 0 0 0-1.93.59 5 5 0 0 1 0 5.82A3.4 3.4 0 0 0 15 11a3.5 3.5 0 0 0 0-7z"/>
        </svg>
        Switch Account
      </button>
    </div>
  </div>
</div>

<script>
  // Account Switcher JavaScript
  (function() {
    'use strict';

    let userInfo = null;
    let accountMenuOpen = false;

    /**
     * Initializes the account switcher
     */
    function initAccountSwitcher() {
      // Load user information
      loadUserInfo();

      // Set up event listeners
      const avatar = document.getElementById('account-avatar');
      const menu = document.getElementById('account-menu');

      if (avatar) {
        avatar.addEventListener('click', toggleAccountMenu);
        avatar.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleAccountMenu();
          }
        });
      }

      // Close menu when clicking outside
      document.addEventListener('click', function(e) {
        if (accountMenuOpen && !document.getElementById('account-switcher').contains(e.target)) {
          closeAccountMenu();
        }
      });

      // Close menu on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && accountMenuOpen) {
          closeAccountMenu();
        }
      });
    }

    /**
     * Loads user information from the server
     */
    function loadUserInfo() {
      google.script.run
        .withSuccessHandler(function(info) {
          userInfo = info;
          updateAccountDisplay(info);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load user info:', error);
          userInfo = {
            email: 'Error loading account',
            name: 'Unknown User',
            initials: '?'
          };
          updateAccountDisplay(userInfo);
        })
        .getCurrentUserInfo();
    }

    /**
     * Updates the account display with user information
     */
    function updateAccountDisplay(info) {
      const initialsEl = document.getElementById('account-initials');
      const emailEl = document.getElementById('account-email');
      const nameEl = document.getElementById('account-name');

      if (initialsEl) {
        initialsEl.textContent = info.initials || '?';
      }

      if (emailEl) {
        emailEl.textContent = info.email || 'Unknown';
      }

      if (nameEl) {
        nameEl.textContent = info.name || 'Unknown User';
      }

      // Update aria-label
      const avatar = document.getElementById('account-avatar');
      if (avatar) {
        avatar.setAttribute('aria-label', `Account menu for ${info.email || 'user'}`);
      }
    }

    /**
     * Toggles the account menu open/closed
     */
    function toggleAccountMenu() {
      if (accountMenuOpen) {
        closeAccountMenu();
      } else {
        openAccountMenu();
      }
    }

    /**
     * Opens the account menu
     */
    function openAccountMenu() {
      const menu = document.getElementById('account-menu');
      const avatar = document.getElementById('account-avatar');

      if (menu) {
        menu.classList.add('show');
        accountMenuOpen = true;

        if (avatar) {
          avatar.setAttribute('aria-expanded', 'true');
        }
      }
    }

    /**
     * Closes the account menu
     */
    function closeAccountMenu() {
      const menu = document.getElementById('account-menu');
      const avatar = document.getElementById('account-avatar');

      if (menu) {
        menu.classList.remove('show');
        accountMenuOpen = false;

        if (avatar) {
          avatar.setAttribute('aria-expanded', 'false');
        }
      }
    }

    /**
     * Switches to a different Google account
     * This function is called from the menu button onclick
     */
    window.switchAccount = function() {
      closeAccountMenu();

      // Show loading message
      const notification = document.getElementById('notification');
      if (notification) {
        notification.textContent = 'Switching accounts...';
        notification.className = 'notification info';
        notification.classList.remove('hidden');
      }

      // Get the switch URL and redirect
      google.script.run
        .withSuccessHandler(function(url) {
          // Add a small delay to show the notification
          setTimeout(function() {
            window.top.location.href = url;
          }, 500);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to get switch URL:', error);
          if (notification) {
            notification.textContent = 'Failed to switch accounts. Please try refreshing the page.';
            notification.className = 'notification error';
          }
        })
        .getAccountSwitchUrl();
    };

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAccountSwitcher);
    } else {
      initAccountSwitcher();
    }
  })();
</script>
