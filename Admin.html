<!-- Admin.html -->
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      /* Common styles shared with main app */
      :root {
        --positive-color: #34A853;
        --negative-color: #EA4335;
        --primary-color: #4285F4;
        --section-bg: #f8f9fa;
        --border-color: #dadce0;
        --header-bg: #4285F4;
        --header-fg: white;
        --text-secondary: #5f6368; /* Added */
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Roboto', Arial, sans-serif;
      }

      body {
        background-color: #f1f3f4;
        color: #202124;
        line-height: 1.5;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 16px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      header h1 {
        color: var(--primary-color);
      }

      .back-btn {
        padding: 8px 16px;
        background-color: #f1f3f4;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        color: #5f6368;
        text-decoration: none;
        display: inline-block;
      }

      .admin-section {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      }

      .section-title {
        font-size: 18px;
        margin-bottom: 16px;
        color: #202124;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
      }

      /* Activity Table */
      .activities-table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
      .activities-table th { text-align: left; background-color: var(--section-bg); padding: 10px; border-bottom: 2px solid var(--border-color); }
      .activities-table td { padding: 10px; border-bottom: 1px solid var(--border-color); }
      .activities-table input, .activities-table select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; }
      .activities-table input[type="number"] { text-align: right; }

      /* Form Actions */
      .form-actions { margin-top: 16px; display: flex; gap: 12px; justify-content: flex-end; }

      .btn { padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; border: none; } /* Simplified base */
      .btn-primary { background-color: var(--primary-color); color: white; }
      .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
      .btn-secondary { background-color: #f1f3f4; color: #5f6368; border: 1px solid var(--border-color); }
      .btn-secondary:hover:not(:disabled) { background-color: #e8eaed; }
      .btn-danger { background-color: var(--negative-color); color: white; }
      .btn-danger:hover:not(:disabled) { background-color: #d93025; }
      .btn:disabled { opacity: 0.65; cursor: not-allowed; } /* General disabled style */
      .btn-sm { padding: 4px 8px; font-size: 12px; height: auto; }


      /* Settings Form */
      .settings-form { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .form-group { margin-bottom: 16px; }
      .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #5f6368; }
      .form-group input { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; }

      .notification { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background-color: #323232; color: white; border-radius: 4px; box-shadow: 0 3px 5px rgba(0,0,0,0.2); transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
      .notification.hidden { opacity: 0; visibility: hidden; }

      /* Activity Controls */
      .activity-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }

      /* Household Management Styles */
      .household-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
      .household-controls input { width: 250px; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; }
      .household-list { margin-top: 20px; }
      .household-card { background-color: white; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
      .household-header { padding: 16px; background-color: var(--section-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
      .household-name { margin: 0; font-size: 18px; font-weight: 500; color: var(--primary-color); }
      .household-actions { display: flex; gap: 8px; }
      .household-members { padding: 16px; }
      .household-members h4 { margin-top: 0; margin-bottom: 12px; font-size: 14px; color: var(--text-secondary); border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
      .household-member { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8f8f8; }
      .member-email { font-weight: 500; }
      .member-date { color: var(--text-secondary); font-size: 12px; }
      .empty-state { text-align: center; padding: 30px; color: var(--text-secondary); background-color: #f9f9f9; border-radius: 8px; }

      /* --- Category Order Styles --- */
      #category-order-list {
        list-style: none;
        padding: 0;
        margin: 0;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        max-height: 400px; /* Limit height */
        overflow-y: auto; /* Enable scrolling */
      }
      .category-order-item {
        padding: 10px 15px;
        border-bottom: 1px solid var(--border-color);
        background-color: white;
        cursor: grab;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
      }
      .category-order-item:last-child { border-bottom: none; }
      .category-order-item:active { cursor: grabbing; background-color: #e8f0fe; } /* Feedback while dragging */
      .drag-handle { /* Simple drag handle icon */
         display: inline-block;
         width: 16px;
         height: 16px;
         cursor: grab;
         background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grip-vertical" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0M7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0M7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0m-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0m3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/></svg>');
         background-repeat: no-repeat;
         background-position: center;
         opacity: 0.5;
      }
      .category-order-item.dragging { /* Style for the item being dragged */
        opacity: 0.5;
        background: #f0f0f0;
      }
      .drag-over { /* Style for potential drop target */
          border-top: 2px dashed var(--primary-color);
          background-color: rgba(66, 133, 244, 0.05);
      }
      /* --- End Category Order Styles --- */

      /* Responsive adjustments */
      @media (max-width: 600px) {
        .settings-form { grid-template-columns: 1fr; }
        .household-controls { flex-direction: column; gap: 10px; align-items: stretch;}
        .household-controls input { width: 100%; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Budget Game Admin</h1>
        <div class="return-nav">
            <a href="<?= getScriptUrl() ?>?view=activity" class="back-btn">Activity Tracker</a>
            <a href="<?= getScriptUrl() ?>?view=dashboard" class="back-btn">Dashboard</a>
            <a href="<?= getScriptUrl() ?>?view=expense" class="back-btn">Expense Tracker</a>
        </div>
      </header>

      <!-- Activity Configuration -->
      <div class="admin-section">
        <h2 class="section-title">Activity Configuration</h2>
        <div class="activity-controls">
          <input type="text" id="search-activities" placeholder="Search activities...">
          <button class="btn btn-secondary" id="add-activity-btn">Add New Activity</button>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="activities-table" id="activities-table">
            <thead>
              <tr>
                <th style="width: 40%;">Activity</th>
                <th style="width: 12%;">Points</th>
                <th style="width: 20%;">Category</th>
                <th style="width: 15%;">Required</th>
                <th style="width: 13%;">Action</th>
              </tr>
            </thead>
            <tbody id="activities-body"><tr><td colspan="5">Loading activities...</td></tr></tbody>
          </table>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" id="reset-activities-btn">Reset Changes</button>
          <button class="btn btn-primary" id="save-activities-btn">Save Activities</button>
        </div>
      </div>

      <!-- Streak Settings -->
      <div class="admin-section">
        <h2 class="section-title">Streak Settings</h2>
        <div class="settings-form">
          <div class="form-group"><label for="threshold-bonus1">Days for Bonus 1:</label><input type="number" id="threshold-bonus1" min="2" max="30"></div>
          <div class="form-group"><label for="bonus-points1">Bonus 1 Points:</label><input type="number" id="bonus-points1" min="1" max="10"></div>
          <div class="form-group"><label for="threshold-bonus2">Days for Bonus 2:</label><input type="number" id="threshold-bonus2" min="3" max="30"></div>
          <div class="form-group"><label for="bonus-points2">Bonus 2 Points:</label><input type="number" id="bonus-points2" min="1" max="10"></div>
          <div class="form-group"><label for="threshold-multiplier">Days for Multiplier:</label><input type="number" id="threshold-multiplier" min="5" max="60"></div>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" id="reset-streak-btn">Reset Changes</button>
          <button class="btn btn-primary" id="save-streak-btn">Save Streak Settings</button>
        </div>
      </div>

      <!-- NEW: Category Order Section -->
      <div class="admin-section">
        <h2 class="section-title">Category Order</h2>
        <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 16px;">Drag and drop categories to change their display order in the Activity Tracker view.</p>
        <ul id="category-order-list">
            <!-- Categories will be populated here -->
            <li class="loading">Loading categories...</li>
        </ul>
        <div class="form-actions">
          <button class="btn btn-secondary" id="reset-category-order-btn">Reset Order</button>
          <button class="btn btn-primary" id="save-category-order-btn">Save Order</button>
        </div>
      </div>
      <!-- END: Category Order Section -->

      <!-- NEW: Category Management Section -->
      <div class="admin-section">
        <h2 class="section-title">Category Management</h2>
        <div class="activity-controls">
          <input type="text" id="search-categories" placeholder="Search categories...">
          <button class="btn btn-secondary" id="add-category-btn">Add New Category</button>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="activities-table" id="categories-table">
            <thead>
              <tr>
                <th style="width: 70%;">Category Name</th>
                <th style="width: 30%;">Actions</th>
              </tr>
            </thead>
            <tbody id="categories-body"><tr><td colspan="2">Loading categories...</td></tr></tbody>
          </table>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" id="reset-categories-btn">Reset Changes</button>
          <button class="btn btn-primary" id="save-categories-btn">Save Categories</button>
        </div>
      </div>
      <!-- END: Category Management Section -->
      
      <!-- Goal Management Section -->
      <div class="admin-section">
        <h2 class="section-title">Goal Management</h2>
        <div class="activity-controls">
          <input type="text" id="search-goals" placeholder="Search goals...">
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary" id="refresh-goals-btn">🔄 Refresh</button>
            <button class="btn btn-secondary" id="add-goal-btn">Add New Goal</button>
          </div>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="activities-table" id="goals-table">
            <thead>
              <tr>
                <th style="width: 25%;">Goal Name</th>
                <th style="width: 12%;">Type</th>
                <th style="width: 12%;">Target</th>
                <th style="width: 12%;">Current</th>
                <th style="width: 12%;">Progress</th>
                <th style="width: 12%;">Status</th>
                <th style="width: 15%;">Actions</th>
              </tr>
            </thead>
            <tbody id="goals-body">
              <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 30px;">
                  <div style="margin-bottom: 10px;">⏳ Loading goals...</div>
                  <div style="font-size: 0.9em; color: #999;">Please wait while we fetch your goal data</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" id="reset-goals-btn">Reset Changes</button>
          <button class="btn btn-primary" id="save-goals-btn">Save Goals</button>
        </div>
      </div>
      <!-- END: Goal Management Section -->

      <!-- Budget Category Management Section -->
      <div class="admin-section">
        <h2 class="section-title">Budget Category Management</h2>
        <div class="activity-controls">
          <input type="text" id="search-budget-categories" placeholder="Search budget categories...">
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary" id="refresh-budget-categories-btn">🔄 Refresh</button>
            <button class="btn btn-secondary" id="add-budget-category-btn">Add New Category</button>
          </div>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="activities-table" id="budget-categories-table">
            <thead>
              <tr>
                <th style="width: 20%;">Category Name</th>
                <th style="width: 15%;">Monthly Budget</th>
                <th style="width: 15%;">Pay Period Budget</th>
                <th style="width: 15%;">Current Spent</th>
                <th style="width: 15%;">Remaining</th>
                <th style="width: 10%;">Status</th>
                <th style="width: 10%;">Actions</th>
              </tr>
            </thead>
            <tbody id="budget-categories-body">
              <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 30px;">
                  <div style="margin-bottom: 10px;">⏳ Loading budget categories...</div>
                  <div style="font-size: 0.9em; color: #999;">Please wait while we fetch your budget data</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" id="reset-budget-categories-btn">Reset Changes</button>
          <button class="btn btn-primary" id="save-budget-categories-btn">Save Budget Categories</button>
        </div>
      </div>
      <!-- END: Budget Category Management Section -->

      <div class="admin-section">
        <h2 class="section-title">Recent Activity Log (Last 7 Days)</h2>
        <div class="activity-controls">
          <button id="load-log-btn" class="btn btn-secondary">Load Log</button>
          <button id="add-log-entry-btn" class="btn btn-primary">Add Manual Entry</button>
        </div>
        <div style="max-height: 500px; overflow-y: auto;">
          <table class="activities-table" id="activity-log-table">
            <thead>
              <tr>
                <th style="width: 12%;">Date</th>
                <th style="width: 20%;">Email</th>
                <th style="width: 58%;">Activities</th>
                <th style="width: 10%;">Actions</th>
              </tr>
            </thead>
            <tbody id="activity-log-body">
              <tr><td colspan="4">Click 'Load Log' to view recent activities</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- Household Management -->
      <div class="admin-section">
        <h2 class="section-title">Household Management</h2>
        <div class="household-controls">
          <button class="btn btn-primary" id="add-household-btn">Add New Household</button>
          <input type="text" id="search-households" placeholder="Search households...">
        </div>
        <div id="household-list" class="household-list"><p class="loading">Loading households...</p></div>
      </div>
    </div>
    <div id="notification" class="notification hidden"></div>
    <!-- Add Entry Modal - Add this at the end of the body -->
    <div id="add-entry-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
      <div style="background: white; max-width: 500px; margin: 100px auto; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
        <h3 id="entry-modal-title">Add Manual Entry</h3>
        <form id="entry-form">
          <div class="form-group">
            <label for="entry-date">Date:</label>
            <input type="date" id="entry-date" required class="form-control">
          </div>
          <div class="form-group">
            <label for="entry-email">Email:</label>
            <input type="email" id="entry-email" required class="form-control">
          </div>
          <div class="form-group">
            <label for="entry-activity">Activity:</label>
            <select id="entry-activity" required class="form-control">
              <option value="">Select an activity...</option>
              <!-- Will be populated dynamically -->
            </select>
          </div>
          <div class="form-actions">
            <button type="button" id="entry-cancel-btn" class="btn btn-secondary">Cancel</button>
            <button type="submit" id="entry-save-btn" class="btn btn-primary">Save Entry</button>
          </div>
        </form>
      </div>
    </div>
    <div id="add-entry-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); padding-top: 60px;">
      <div style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; border-radius: 8px; width: 90%; max-width: 500px;">
        <h3 id="entry-modal-title">Add Manual Entry</h3>
        <form id="entry-form">
          <div class="form-group">
            <label for="entry-date">Date:</label>
            <input type="date" id="entry-date" required class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div class="form-group">
            <label for="entry-email">Email:</label>
            <input type="email" id="entry-email" required class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div class="form-group">
            <label for="entry-activity">Activity:</label>
            <select id="entry-activity" required class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">Select an activity...</option>
              <!-- Will be populated dynamically -->
            </select>
          </div>
          <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button type="button" id="entry-cancel-btn" class="btn btn-secondary">Cancel</button>
            <button type="submit" id="entry-save-btn" class="btn btn-primary">Save Entry</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Goal Modal -->
    <div id="goal-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); padding-top: 60px;">
      <div style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; border-radius: 8px; width: 90%; max-width: 500px;">
        <h3 id="goal-modal-title">Add New Goal</h3>
        <form id="goal-form">
          <div class="form-group">
            <label for="goal-name">Goal Name:</label>
            <input type="text" id="goal-name" required class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;" placeholder="e.g., Emergency Fund">
          </div>
          <div class="form-group">
            <label for="goal-type">Goal Type:</label>
            <select id="goal-type" required class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">Select goal type...</option>
              <option value="debt">Debt Reduction</option>
              <option value="savings">Savings Goal</option>
              <option value="vacation_fund">Vacation Fund</option>
            </select>
          </div>
          <div class="form-group">
            <label for="goal-target">Target Amount:</label>
            <input type="number" id="goal-target" required class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;" min="0" step="0.01" placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="goal-current">Current Amount:</label>
            <input type="number" id="goal-current" required class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;" min="0" step="0.01" placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="goal-target-date">Target Date:</label>
            <input type="date" id="goal-target-date" class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button type="button" id="goal-cancel-btn" class="btn btn-secondary">Cancel</button>
            <button type="submit" id="goal-save-btn" class="btn btn-primary">Save Goal</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Budget Category Modal -->
    <div id="budget-category-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); padding-top: 60px;">
      <div style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; border-radius: 8px; width: 90%; max-width: 500px;">
        <h3 id="budget-category-modal-title">Add New Budget Category</h3>
        <form id="budget-category-form">
          <div class="form-group">
            <label for="budget-category-name">Category Name:</label>
            <input type="text" id="budget-category-name" required class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;" placeholder="e.g., Groceries">
          </div>
          <div class="form-group">
            <label for="budget-monthly-budget">Monthly Budget:</label>
            <input type="number" id="budget-monthly-budget" required class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;" min="0" step="0.01" placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="budget-pay-period-budget">Pay Period Budget:</label>
            <input type="number" id="budget-pay-period-budget" required class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;" min="0" step="0.01" placeholder="0.00">
            <small style="color: #666; font-size: 0.85em;">Typically half of monthly budget for bi-weekly pay periods</small>
          </div>
          <div class="form-group">
            <label for="budget-current-spent">Current Spent:</label>
            <input type="number" id="budget-current-spent" class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;" min="0" step="0.01" placeholder="0.00" value="0">
            <small style="color: #666; font-size: 0.85em;">Leave as 0 for new categories</small>
          </div>
          <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button type="button" id="budget-category-cancel-btn" class="btn btn-secondary">Cancel</button>
            <button type="submit" id="budget-category-save-btn" class="btn btn-primary">Save Category</button>
          </div>
        </form>
      </div>
    </div>
    
    <script>
      // Global state
      let activitiesData = [];
      let originalActivitiesData = [];
      let categoriesList = []; // This will store the ORDERED list
      let originalCategoriesList = []; // Store the initially loaded order
      let streakSettings = {};
      let originalStreakSettings = {};
      let goalsData = [];
      let originalGoalsData = [];
      let budgetCategoriesData = [];
      let originalBudgetCategoriesData = [];

      // Drag and Drop State
      let draggedItem = null;

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', initializeAdmin);

      function initializeAdmin() {
        // Set up event listeners
        document.getElementById('add-activity-btn').addEventListener('click', addNewActivity);
        document.getElementById('reset-activities-btn').addEventListener('click', resetActivities);
        document.getElementById('save-activities-btn').addEventListener('click', saveActivities);
        document.getElementById('reset-streak-btn').addEventListener('click', resetStreakSettings);
        document.getElementById('save-streak-btn').addEventListener('click', saveStreakSettings);
        document.getElementById('search-activities').addEventListener('input', filterActivities);

        // Category Order Listeners
        document.getElementById('reset-category-order-btn').addEventListener('click', resetCategoryOrder);
        document.getElementById('save-category-order-btn').addEventListener('click', saveCategoryOrder);
        
        // NEW: Category Management Listeners
        document.getElementById('add-category-btn').addEventListener('click', addNewCategory);
        document.getElementById('reset-categories-btn').addEventListener('click', resetCategories);
        document.getElementById('save-categories-btn').addEventListener('click', saveCategories);
        document.getElementById('search-categories').addEventListener('input', filterCategories);

        // Goal Management Listeners
        document.getElementById('refresh-goals-btn').addEventListener('click', refreshGoals);
        document.getElementById('add-goal-btn').addEventListener('click', addNewGoal);
        document.getElementById('reset-goals-btn').addEventListener('click', resetGoals);
        document.getElementById('save-goals-btn').addEventListener('click', saveGoals);
        document.getElementById('search-goals').addEventListener('input', filterGoals);
        document.getElementById('goal-cancel-btn').addEventListener('click', closeGoalModal);
        document.getElementById('goal-form').addEventListener('submit', handleGoalSubmit);

        // Budget Category Management Listeners
        document.getElementById('refresh-budget-categories-btn').addEventListener('click', refreshBudgetCategories);
        document.getElementById('add-budget-category-btn').addEventListener('click', addNewBudgetCategory);
        document.getElementById('reset-budget-categories-btn').addEventListener('click', resetBudgetCategories);
        document.getElementById('save-budget-categories-btn').addEventListener('click', saveBudgetCategories);
        document.getElementById('search-budget-categories').addEventListener('input', filterBudgetCategories);
        document.getElementById('budget-category-cancel-btn').addEventListener('click', closeBudgetCategoryModal);
        document.getElementById('budget-category-form').addEventListener('submit', handleBudgetCategorySubmit);

        // Event listeners for household management
        document.getElementById('add-household-btn').addEventListener('click', addHouseholdHandler);
        document.getElementById('search-households').addEventListener('input', filterHouseholds);

        // Load configuration data
        google.script.run
          .withSuccessHandler(handleConfigData)
          .withFailureHandler(handleError)
          .getAdminConfigData(); // Calls the function in WebApp.gs

        // Load goals data
        console.log('[ADMIN GOALS DEBUG] Calling getGoalsData() from server...');
        google.script.run
          .withSuccessHandler(handleGoalsData)
          .withFailureHandler(function(error) {
            console.log('[ADMIN GOALS DEBUG] Error loading goals:', error);
            
            // Show specific error message for goals loading
            const tbody = document.getElementById('goals-body');
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align: center; color: #ea4335; padding: 30px;">
                  <div style="margin-bottom: 10px;">⚠️ Error loading goals</div>
                  <div style="font-size: 0.9em; color: #666;">
                    ${error.message || 'Unknown error occurred'}
                  </div>
                  <div style="margin-top: 10px;">
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">Retry</button>
                  </div>
                </td>
              </tr>
            `;
            
            handleError(error);
          })
          .getGoalsData();

        // Load budget categories data
        console.log('[ADMIN BUDGET DEBUG] Calling getExpenseTrackerData() from server...');
        google.script.run
          .withSuccessHandler(handleBudgetCategoriesData)
          .withFailureHandler(function(error) {
            console.log('[ADMIN BUDGET DEBUG] Error loading budget categories:', error);
            
            // Show specific error message for budget categories loading
            const tbody = document.getElementById('budget-categories-body');
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align: center; color: #ea4335; padding: 30px;">
                  <div style="margin-bottom: 10px;">⚠️ Error loading budget categories</div>
                  <div style="font-size: 0.9em; color: #666;">
                    ${error.message || 'Unknown error occurred'}
                  </div>
                  <div style="margin-top: 10px;">
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">Retry</button>
                  </div>
                </td>
              </tr>
            `;
            
            handleError(error);
          })
          .getExpenseTrackerData();

        // Load households when the admin page is initialized
        loadHouseholds(); // Calls the function below
      }

      /**
       * Processes the config data received from the server for Admin UI
       * Handles potential inconsistencies in streak settings structure
       */
      function handleConfigData(data) {
        console.log("Admin Config Data Received:", data);
        // Use the ORDERED category list from the server
        categoriesList = data.categoryOrder || data.categories || []; // Use categoryOrder first
        originalCategoriesList = JSON.parse(JSON.stringify(categoriesList)); // Store original order

        activitiesData = data.pointsReference || [];
        originalActivitiesData = JSON.parse(JSON.stringify(activitiesData));

        // --- Process Streak Settings (Handle potential case difference) ---
        // ... (streak settings processing remains the same) ...
        const rawStreakSettings = data.streakSettings || {};
        streakSettings = { thresholds: { bonus1: 0, bonus2: 0, multiplier: 0 }, bonusPoints: { bonus1: 0, bonus2: 0 } };
        streakSettings.thresholds.bonus1 = rawStreakSettings.thresholds?.bonus1 ?? rawStreakSettings.thresholds?.BONUS_1 ?? 3;
        streakSettings.thresholds.bonus2 = rawStreakSettings.thresholds?.bonus2 ?? rawStreakSettings.thresholds?.BONUS_2 ?? 7;
        streakSettings.thresholds.multiplier = rawStreakSettings.thresholds?.multiplier ?? rawStreakSettings.thresholds?.MULTIPLIER ?? 14;
        streakSettings.bonusPoints.bonus1 = rawStreakSettings.bonusPoints?.bonus1 ?? rawStreakSettings.bonusPoints?.BONUS_1 ?? 1;
        streakSettings.bonusPoints.bonus2 = rawStreakSettings.bonusPoints?.bonus2 ?? rawStreakSettings.bonusPoints?.BONUS_2 ?? 2;
        originalStreakSettings = JSON.parse(JSON.stringify(streakSettings));
        // console.log("Processed Streak Settings:", streakSettings);

        // Render UI
        renderActivitiesTable(); // Uses ORDERED categoriesList for dropdowns now
        populateStreakSettings();
        renderCategoryOrderList(); // Render the sortable list
        renderCategoriesTable(); // NEW: Render the categories management table
      }

      // --- Category Order Functions ---

      function renderCategoryOrderList() {
          const listElement = document.getElementById('category-order-list');
          listElement.innerHTML = ''; // Clear loading/previous

          if (!categoriesList || categoriesList.length === 0) {
              listElement.innerHTML = '<li class="info-message">No categories found.</li>';
              return;
          }

          categoriesList.forEach((category, index) => {
              const listItem = document.createElement('li');
              listItem.className = 'category-order-item';
              listItem.setAttribute('draggable', 'true');
              listItem.dataset.index = index; // Store original index if needed? Or just rely on order
              listItem.dataset.category = category; // Store category name

              listItem.innerHTML = `
                  <span class="drag-handle" title="Drag to reorder"></span>
                  <span class="category-name">${category}</span>
              `;

              // Add drag-and-drop event listeners
              listItem.addEventListener('dragstart', handleDragStart);
              listItem.addEventListener('dragover', handleDragOver);
              listItem.addEventListener('dragenter', handleDragEnter);
              listItem.addEventListener('dragleave', handleDragLeave);
              listItem.addEventListener('drop', handleDrop);
              listItem.addEventListener('dragend', handleDragEnd);

              listElement.appendChild(listItem);
          });
      }

      function handleDragStart(e) {
          draggedItem = this;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', this.innerHTML); // Optional: for visual feedback
          setTimeout(() => this.classList.add('dragging'), 0); // Make original item semi-transparent
      }

      function handleDragEnd(e) {
          this.classList.remove('dragging');
          // Clean up any remaining drag-over styles
          document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
          draggedItem = null;
      }

      function handleDragOver(e) {
          e.preventDefault(); // Necessary to allow dropping
          e.dataTransfer.dropEffect = 'move';
          return false;
      }

      function handleDragEnter(e) {
          e.preventDefault();
          // Add visual indicator only if dropping onto a different item
          if (draggedItem && this !== draggedItem) {
              this.classList.add('drag-over');
          }
      }

      function handleDragLeave(e) {
          this.classList.remove('drag-over');
      }

      function handleDrop(e) {
          e.stopPropagation(); // Prevent event bubbling

          if (draggedItem && this !== draggedItem) {
              // Get the current order from the DOM list items
              const list = document.getElementById('category-order-list');
              const items = Array.from(list.children);
              const draggedIndex = items.indexOf(draggedItem);
              const targetIndex = items.indexOf(this);

              // Reorder the DOM elements
              if (draggedIndex < targetIndex) {
                  list.insertBefore(draggedItem, this.nextSibling);
              } else {
                  list.insertBefore(draggedItem, this);
              }

              // Update the global categoriesList array based on the new DOM order
              updateCategoriesListFromDOM();
          }
          this.classList.remove('drag-over'); // Ensure indicator is removed
          return false;
      }

      function updateCategoriesListFromDOM() {
          const listElement = document.getElementById('category-order-list');
          const items = listElement.querySelectorAll('.category-order-item');
          categoriesList = Array.from(items).map(item => item.dataset.category);
          console.log("Updated categoriesList order:", categoriesList);
          // After reordering, might need to update activity dropdowns if you allow category changes
          // For now, just updating the order state.
      }


      function resetCategoryOrder() {
          if (confirm("Reset category order back to the last saved state?")) {
              categoriesList = JSON.parse(JSON.stringify(originalCategoriesList));
              renderCategoryOrderList();
              showNotification('Category order reset.');
          }
      }

      function saveCategoryOrder() {
          // Disable buttons during save
          toggleSaveButtons(true, 'category');

          console.log("Saving category order:", categoriesList);
          google.script.run
              .withSuccessHandler(handleCategoryOrderSaved)
              .withFailureHandler((err) => handleError(err, 'category'))
              .saveCategoryOrder(categoriesList); // New server function
      }

      function handleCategoryOrderSaved(result) {
          toggleSaveButtons(false, 'category');
          if (result.success) {
              showNotification(result.message);
              // Update original order to reflect the save
              originalCategoriesList = JSON.parse(JSON.stringify(categoriesList));
          } else {
              showNotification('Error: ' + result.message, true);
              // Optionally reset UI if save failed?
              // resetCategoryOrder();
          }
      }


      // --- End Category Order Functions ---

      function renderActivitiesTable() {
        const tbody = document.getElementById('activities-body');
        tbody.innerHTML = ''; // Clear loading/previous

        if (!activitiesData || activitiesData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">No activities found. Add your first activity!</td></tr>';
          return;
        }

        activitiesData.forEach((activity, index) => {
          const tr = document.createElement('tr');
          tr.dataset.index = index;

          // Activity name cell
          const nameCell = document.createElement('td');
          const nameInput = document.createElement('input');
          nameInput.type = 'text'; nameInput.value = activity.activity || '';
          nameInput.dataset.field = 'activity'; nameInput.addEventListener('change', updateActivity);
          nameCell.appendChild(nameInput);

          // Points cell
          const pointsCell = document.createElement('td');
          const pointsInput = document.createElement('input');
          pointsInput.type = 'number'; pointsInput.value = activity.points ?? 0;
          pointsInput.dataset.field = 'points'; pointsInput.addEventListener('change', updateActivity);
          pointsCell.appendChild(pointsInput);

          // Category cell - Dropdown uses the potentially REORDERED categoriesList
          const categoryCell = document.createElement('td');
          const categorySelect = document.createElement('select');
          categorySelect.dataset.field = 'category'; categorySelect.addEventListener('change', updateActivity);
          // Ensure categoriesList is an array
          const currentCategories = Array.isArray(categoriesList) ? categoriesList : [];
          currentCategories.forEach(category => { // Use the (potentially reordered) global list
            const option = document.createElement('option');
            option.value = category; option.textContent = category;
            option.selected = category === String(activity.category || '');
            categorySelect.appendChild(option);
          });
          // Add current category if it's somehow not in the main list anymore
          const currentActivityCategory = String(activity.category || '');
          if (currentActivityCategory && !currentCategories.includes(currentActivityCategory)) {
              const currentOption = document.createElement('option');
              currentOption.value = currentActivityCategory;
              currentOption.textContent = currentActivityCategory + " (current)";
              currentOption.selected = true;
              categorySelect.appendChild(currentOption);
              console.warn(`Activity "${activity.activity}" has category "${currentActivityCategory}" not in current list.`);
          }
          categoryCell.appendChild(categorySelect);

          // Required cell
          const requiredCell = document.createElement('td');
          const requiredCheckbox = document.createElement('input');
          requiredCheckbox.type = 'checkbox';
          requiredCheckbox.checked = activity.required === true;
          requiredCheckbox.dataset.field = 'required';
          requiredCheckbox.addEventListener('change', updateActivity);
          requiredCell.appendChild(requiredCheckbox);

          // Action cell
          const actionCell = document.createElement('td');
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-danger btn-sm'; deleteBtn.innerHTML = '×'; deleteBtn.title = 'Delete Activity';
          deleteBtn.addEventListener('click', deleteActivity);
          actionCell.appendChild(deleteBtn);

          tr.appendChild(nameCell); tr.appendChild(pointsCell); tr.appendChild(categoryCell); tr.appendChild(requiredCell); tr.appendChild(actionCell);
          applyRowStyling(tr, parseFloat(activity.points || 0));
          tbody.appendChild(tr);
        });
      }

      function applyRowStyling(rowElement, points) {
          // ... (styling function remains the same) ...
          if (points > 0) { rowElement.style.backgroundColor = 'rgba(52, 168, 83, 0.05)'; }
          else if (points < 0) { rowElement.style.backgroundColor = 'rgba(234, 67, 53, 0.05)'; }
          else { rowElement.style.backgroundColor = ''; }
      }


      function populateStreakSettings() {
        // ... (remains the same) ...
        document.getElementById('threshold-bonus1').value = streakSettings.thresholds?.bonus1 ?? '';
        document.getElementById('threshold-bonus2').value = streakSettings.thresholds?.bonus2 ?? '';
        document.getElementById('threshold-multiplier').value = streakSettings.thresholds?.multiplier ?? '';
        document.getElementById('bonus-points1').value = streakSettings.bonusPoints?.bonus1 ?? '';
        document.getElementById('bonus-points2').value = streakSettings.bonusPoints?.bonus2 ?? '';
      }

      function updateActivity(event) {
        // ... (remains the same) ...
        const inputElement = event.target;
        const tr = inputElement.closest('tr'); const index = parseInt(tr.dataset.index); const field = inputElement.dataset.field;
        let value = inputElement.value;
        if (isNaN(index) || !field) { console.error("Could not find index or field for updated activity."); return; }
        if (field === 'points') { value = parseFloat(value) || 0; }
        if (field === 'required') { value = inputElement.checked; }
        if (activitiesData[index]) { activitiesData[index][field] = value; if (field === 'points') { applyRowStyling(tr, value); } }
        else { console.error("Activity data not found for index:", index); }
      }

      function addNewActivity() {
        // ... (remains the same) ...
        const newActivity = { activity: 'New Activity', points: 1, category: categoriesList[0] || 'Uncategorized', required: false };
        activitiesData.push(newActivity); renderActivitiesTable();
        const lastRow = document.querySelector('#activities-body tr:last-child');
        if (lastRow) { const firstInput = lastRow.querySelector('input[type="text"]'); if (firstInput) { firstInput.focus(); firstInput.select(); } lastRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
      }

      function deleteActivity(event) {
        // ... (remains the same) ...
         const btn = event.target; const tr = btn.closest('tr'); const index = parseInt(tr.dataset.index);
         if (isNaN(index)) { console.error("Could not find index for activity deletion."); return; }
         const activityName = activitiesData[index]?.activity || 'this activity';
         if (confirm(`Are you sure you want to delete "${activityName}"?`)) { activitiesData.splice(index, 1); renderActivitiesTable(); showNotification(`Deleted activity: "${activityName}"`); }
      }

      function resetActivities() {
        // ... (remains the same) ...
        if (confirm("Reset all activity changes back to the last saved state?")) { activitiesData = JSON.parse(JSON.stringify(originalActivitiesData)); renderActivitiesTable(); showNotification('Activities reset to last saved values'); }
      }

      function saveActivities() {
        // ... (validation and call remain the same) ...
        const invalidActivities = activitiesData.filter(activity => !activity.activity || activity.activity.trim() === '');
        if (invalidActivities.length > 0) { showNotification('Error: All activities must have a name', true); return; }
        toggleSaveButtons(true, 'activities');
        google.script.run.withSuccessHandler(handleActivitiesSaved).withFailureHandler((err) => handleError(err, 'activities')).saveActivitiesData(activitiesData);
      }

      function handleActivitiesSaved(result) {
        // ... (remains the same) ...
        toggleSaveButtons(false, 'activities');
        if (result.success) { showNotification(result.message); originalActivitiesData = JSON.parse(JSON.stringify(activitiesData)); }
        else { showNotification('Error: ' + result.message, true); }
      }

      function resetStreakSettings() {
        // ... (remains the same) ...
         if (confirm("Reset streak settings back to the last saved state?")) { streakSettings = JSON.parse(JSON.stringify(originalStreakSettings)); populateStreakSettings(); showNotification('Streak settings reset to last saved values'); }
      }

      /** Saves updated streak settings - now saves only UPPERCASE */
      function saveStreakSettings() {
        // ... (validation remains the same) ...
        const newSettings = { thresholds: { bonus1: parseInt(document.getElementById('threshold-bonus1').value) || 0, bonus2: parseInt(document.getElementById('threshold-bonus2').value) || 0, multiplier: parseInt(document.getElementById('threshold-multiplier').value) || 0 }, bonusPoints: { bonus1: parseInt(document.getElementById('bonus-points1').value) || 0, bonus2: parseInt(document.getElementById('bonus-points2').value) || 0 } };
        if (newSettings.thresholds.bonus1 < 0 || newSettings.thresholds.bonus2 < 0 || newSettings.thresholds.multiplier < 0 || newSettings.bonusPoints.bonus1 < 0 || newSettings.bonusPoints.bonus2 < 0) { showNotification('Error: All streak values must be zero or positive.', true); return; }
        if (newSettings.thresholds.bonus1 > 0 && newSettings.thresholds.bonus2 > 0 && newSettings.thresholds.bonus1 >= newSettings.thresholds.bonus2) { showNotification('Error: Bonus 1 threshold must be less than Bonus 2 threshold (if both > 0).', true); return; }
        if (newSettings.thresholds.bonus2 > 0 && newSettings.thresholds.multiplier > 0 && newSettings.thresholds.bonus2 >= newSettings.thresholds.multiplier) { showNotification('Error: Bonus 2 threshold must be less than Multiplier threshold (if both > 0).', true); return; }

        toggleSaveButtons(true, 'streak');
        // Prepare settings with only UPPERCASE keys for saving
        const serverSettings = {
          thresholds: { BONUS_1: newSettings.thresholds.bonus1, BONUS_2: newSettings.thresholds.bonus2, MULTIPLIER: newSettings.thresholds.multiplier },
          bonusPoints: { BONUS_1: newSettings.bonusPoints.bonus1, BONUS_2: newSettings.bonusPoints.bonus2 }
        };
        google.script.run.withSuccessHandler(handleStreakSettingsSaved).withFailureHandler((err) => handleError(err, 'streak')).saveStreakSettings(serverSettings);
      }

      function handleStreakSettingsSaved(result) {
        // ... (remains the same, updates local lowercase state from UI) ...
        toggleSaveButtons(false, 'streak');
        if (result.success) {
          showNotification(result.message);
          streakSettings = { thresholds: { bonus1: parseInt(document.getElementById('threshold-bonus1').value) || 0, bonus2: parseInt(document.getElementById('threshold-bonus2').value) || 0, multiplier: parseInt(document.getElementById('threshold-multiplier').value) || 0 }, bonusPoints: { bonus1: parseInt(document.getElementById('bonus-points1').value) || 0, bonus2: parseInt(document.getElementById('bonus-points2').value) || 0 } };
          originalStreakSettings = JSON.parse(JSON.stringify(streakSettings));
        } else { showNotification('Error: ' + result.message, true); }
      }

      function filterActivities() {
        // ... (remains the same) ...
        const searchTerm = document.getElementById('search-activities').value.toLowerCase();
        const rows = document.querySelectorAll('#activities-body tr');
        rows.forEach(row => { const nameInput = row.querySelector('input[type="text"]'); const noDataCell = row.querySelector('td[colspan="4"]'); if (noDataCell) { row.style.display = 'none'; return; } if (!nameInput) return; const activityName = nameInput.value.toLowerCase(); row.style.display = activityName.includes(searchTerm) ? '' : 'none'; });
      }

      function toggleSaveButtons(disabled, type = 'all') {
          // ADD 'category' type
          if (type === 'all' || type === 'activities') {
            document.getElementById('save-activities-btn').disabled = disabled;
            document.getElementById('reset-activities-btn').disabled = disabled;
          }
          if (type === 'all' || type === 'streak') {
            document.getElementById('save-streak-btn').disabled = disabled;
            document.getElementById('reset-streak-btn').disabled = disabled;
          }
          if (type === 'all' || type === 'category') { // NEW
            document.getElementById('save-category-order-btn').disabled = disabled;
            document.getElementById('reset-category-order-btn').disabled = disabled;
          }
          // ... (optional add/delete button disabling) ...
      }


      function navigateToApp() {
        google.script.run.withSuccessHandler(url => {
            window.top.location.href = url; // Use window.top to escape iframe if necessary
        }).getScriptUrl();
      }

      function showNotification(message, isError = false) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.backgroundColor = isError ? 'var(--negative-color)' : '#323232';
        notification.classList.remove('hidden');

        // Hide after 3 seconds
        setTimeout(() => {
          notification.classList.add('hidden');
        }, 3000);
      }

      function handleError(error, buttonType = 'all') {
        console.error('Error:', error);
        showNotification('Error: ' + (error.message || 'Unknown server error'), true);
        toggleSaveButtons(false, buttonType); // Re-enable relevant buttons
        // Also re-enable household buttons on general error
        if (document.getElementById('add-household-btn')) {
            document.getElementById('add-household-btn').disabled = false;
        }
      }

      // --- Household Management Functions ---

      function loadHouseholds() {
        const householdList = document.getElementById('household-list');
        householdList.innerHTML = '<p class="loading">Loading households...</p>';

        google.script.run
          .withSuccessHandler(renderHouseholds)
          .withFailureHandler(function(error) {
            handleError(error); // Use generic error handler
            householdList.innerHTML = `<div class="error-message">Failed to load households: ${error.message || 'Unknown error'}</div>`;
          })
          .getHouseholdAdminData(); // Calls WebApp.gs function
      }

      function renderHouseholds(households) {
        const householdList = document.getElementById('household-list');
        householdList.innerHTML = ''; // Clear previous content or loading message

        if (!households || households.length === 0) {
          householdList.innerHTML = `
            <div class="empty-state">
              <p>No households found. Create your first household!</p>
            </div>
          `;
          return;
        }

        households.forEach(household => {
          const householdCard = document.createElement('div');
          householdCard.className = 'household-card';
          householdCard.dataset.id = household.id; // Store ID on the element

          const membersList = (household.members || []).map(member => `
            <div class="household-member">
              <span class="member-email">${member.email || 'N/A'}</span>
              <span class="member-date">Added: ${member.dateAdded || 'N/A'}</span>
              <button class="btn btn-danger btn-sm remove-member-btn"
                      data-email="${member.email || ''}"
                      data-household="${household.id}"
                      title="Remove ${member.email || ''}">
                ×
              </button>
            </div>
          `).join('');

          householdCard.innerHTML = `
            <div class="household-header">
              <h3 class="household-name">${household.name}</h3>
              <div class="household-actions">
                <button class="btn btn-secondary btn-sm add-user-btn" data-household="${household.id}" data-name="${household.name}">Add User</button>
                <button class="btn btn-danger btn-sm delete-household-btn" data-household="${household.id}" data-name="${household.name}">Delete Household</button>
              </div>
            </div>
            <div class="household-members">
              <h4>Members (${(household.members || []).length})</h4>
              ${membersList || '<p>No members found.</p>'}
            </div>
          `;

          householdList.appendChild(householdCard);
        });

        // Re-attach event listeners after rendering
        attachHouseholdEventListeners();
      }

      function attachHouseholdEventListeners() {
          document.querySelectorAll('.add-user-btn').forEach(btn => {
            // Remove existing listener before adding new one to prevent duplicates if re-rendering
            btn.replaceWith(btn.cloneNode(true));
            document.querySelector(`.add-user-btn[data-household="${btn.dataset.household}"]`).addEventListener('click', function() {
                const householdId = this.dataset.household;
                const householdName = this.dataset.name;
                showAddUserDialog(householdId, householdName);
            });
        });

        document.querySelectorAll('.remove-member-btn').forEach(btn => {
            btn.replaceWith(btn.cloneNode(true));
            document.querySelector(`.remove-member-btn[data-email="${btn.dataset.email}"][data-household="${btn.dataset.household}"]`).addEventListener('click', function() {
                const email = this.dataset.email;
                const householdId = this.dataset.household;
                removeUserFromHouseholdHandler(householdId, email);
            });
        });

        document.querySelectorAll('.delete-household-btn').forEach(btn => {
             btn.replaceWith(btn.cloneNode(true));
            document.querySelector(`.delete-household-btn[data-household="${btn.dataset.household}"]`).addEventListener('click', function() {
                const householdId = this.dataset.household;
                const householdName = this.dataset.name;
                deleteHouseholdHandler(householdId, householdName);
            });
        });
      }


      function addHouseholdHandler() {
        const name = prompt("Enter name for the new household:");
        if (!name || name.trim() === '') return; // User cancelled or entered empty name

        const email = prompt(`Enter email address for the first member of "${name}":`);
        if (!email || email.trim() === '') return; // User cancelled or empty

        // Basic email validation
        if (!validateEmail(email)) {
          showNotification('Please enter a valid email address', true);
          return;
        }

        // Disable add button during operation
        const addBtn = document.getElementById('add-household-btn');
        if (addBtn) addBtn.disabled = true;

        google.script.run
          .withSuccessHandler(function(result) {
            if (addBtn) addBtn.disabled = false;
            if (result.success) {
              showNotification(result.message);
              loadHouseholds(); // Refresh the list
            } else {
              showNotification('Error: ' + result.message, true);
            }
          })
          .withFailureHandler(function(error) {
            if (addBtn) addBtn.disabled = false;
            handleError(error); // Use generic handler
          })
          .addHousehold(name.trim(), email.trim()); // Calls WebApp.gs function
      }

      function showAddUserDialog(householdId, householdName) {
        const email = prompt(`Enter email address to add to "${householdName}":`);
        if (!email || email.trim() === '') return; // User cancelled or empty

        if (!validateEmail(email)) {
          showNotification('Please enter a valid email address', true);
          return;
        }

        // Optionally disable the specific 'Add User' button during the request?
        // Or just rely on the general error handling/success refresh.

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showNotification(result.message);
              loadHouseholds(); // Refresh the list
            } else {
              showNotification('Error: ' + result.message, true);
            }
          })
          .withFailureHandler(handleError)
          .addUserToHousehold(householdId, email.trim()); // Calls WebApp.gs function
      }

      function removeUserFromHouseholdHandler(householdId, email) {
        if (!confirm(`Are you sure you want to remove ${email} from this household?`)) {
          return; // User cancelled
        }

        // Disable button during removal? Could be complex to target specific button.
        // Rely on visual refresh for now.

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showNotification(result.message);
              // Refresh the entire list to ensure counts etc. are correct
              loadHouseholds();
            } else {
              showNotification('Error: ' + result.message, true);
            }
          })
          .withFailureHandler(handleError)
          .removeUserFromHousehold(householdId, email); // Calls WebApp.gs function
      }

      function deleteHouseholdHandler(householdId, householdName) {
        if (!confirm(`Are you sure you want to delete the household "${householdName}"?\n\nThis will remove ALL users from this household and cannot be undone.`)) {
          return; // User cancelled
        }

        // Disable button?

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showNotification(result.message);
              loadHouseholds(); // Refresh the list
            } else {
              showNotification('Error: ' + result.message, true);
            }
          })
          .withFailureHandler(handleError)
          .deleteHousehold(householdId); // Calls WebApp.gs function
      }

      function filterHouseholds() {
        const searchTerm = document.getElementById('search-households').value.toLowerCase();
        const households = document.querySelectorAll('.household-card');

        households.forEach(household => {
          const nameElement = household.querySelector('.household-name');
          const memberElements = household.querySelectorAll('.member-email');

          const name = nameElement ? nameElement.textContent.toLowerCase() : '';
          const members = memberElements ? Array.from(memberElements).map(el => el.textContent.toLowerCase()) : [];

          const nameMatch = name.includes(searchTerm);
          const memberMatch = members.some(member => member.includes(searchTerm));

          household.style.display = (nameMatch || memberMatch) ? '' : 'none';
        });
      }

      function validateEmail(email) {
          // Simple regex for basic email format check
          const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return re.test(String(email).toLowerCase());
      }

      // --- Category Management Functions ---

      function renderCategoriesTable() {
        const tbody = document.getElementById('categories-body');
        tbody.innerHTML = ''; // Clear loading/previous

        if (!categoriesList || categoriesList.length === 0) {
          tbody.innerHTML = '<tr><td colspan="2">No categories found. Add your first category!</td></tr>';
          return;
        }

        categoriesList.forEach((category, index) => {
          const tr = document.createElement('tr');
          tr.dataset.index = index;

          // Category name cell
          const nameCell = document.createElement('td');
          const nameInput = document.createElement('input');
          nameInput.type = 'text'; nameInput.value = category || '';
          nameInput.dataset.field = 'category'; nameInput.addEventListener('change', updateCategory);
          nameCell.appendChild(nameInput);

          // Action cell
          const actionCell = document.createElement('td');
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-danger btn-sm'; deleteBtn.innerHTML = '×'; deleteBtn.title = 'Delete Category';
          deleteBtn.addEventListener('click', deleteCategory);
          actionCell.appendChild(deleteBtn);

          tr.appendChild(nameCell); tr.appendChild(actionCell);
          tbody.appendChild(tr);
        });
      }

      function updateCategory(event) {
        const inputElement = event.target;
        const tr = inputElement.closest('tr'); const index = parseInt(tr.dataset.index); const field = inputElement.dataset.field;
        let value = inputElement.value;
        if (isNaN(index) || !field) { console.error("Could not find index or field for updated category."); return; }
        if (categoriesList[index]) { categoriesList[index] = value; }
        else { console.error("Category data not found for index:", index); }
      }

      function addNewCategory() {
        const newCategory = 'New Category';
        categoriesList.push(newCategory); renderCategoriesTable();
        const lastRow = document.querySelector('#categories-body tr:last-child');
        if (lastRow) { const firstInput = lastRow.querySelector('input[type="text"]'); if (firstInput) { firstInput.focus(); firstInput.select(); } lastRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
      }

      function deleteCategory(event) {
        const btn = event.target; const tr = btn.closest('tr'); const index = parseInt(tr.dataset.index);
        if (isNaN(index)) { console.error("Could not find index for category deletion."); return; }
        const categoryName = categoriesList[index] || 'this category';
        if (confirm(`Are you sure you want to delete "${categoryName}"?`)) { categoriesList.splice(index, 1); renderCategoriesTable(); showNotification(`Deleted category: "${categoryName}"`); }
      }

      function resetCategories() {
        if (confirm("Reset all category changes back to the last saved state?")) { categoriesList = JSON.parse(JSON.stringify(originalCategoriesList)); renderCategoriesTable(); showNotification('Categories reset to last saved values'); }
      }

      function saveCategories() {
        const invalidCategories = categoriesList.filter(category => !category || category.trim() === '');
        if (invalidCategories.length > 0) { showNotification('Error: All categories must have a name', true); return; }
        toggleSaveButtons(true, 'category');
        google.script.run.withSuccessHandler(handleCategoriesSaved).withFailureHandler((err) => handleError(err, 'category')).saveCategoriesData(categoriesList);
      }

      function handleCategoriesSaved(result) {
        toggleSaveButtons(false, 'category');
        if (result.success) { showNotification(result.message); originalCategoriesList = JSON.parse(JSON.stringify(categoriesList)); }
        else { showNotification('Error: ' + result.message, true); }
      }

      function filterCategories() {
        const searchTerm = document.getElementById('search-categories').value.toLowerCase();
        const rows = document.querySelectorAll('#categories-body tr');
        rows.forEach(row => { const nameInput = row.querySelector('input[type="text"]'); const noDataCell = row.querySelector('td[colspan="2"]'); if (noDataCell) { row.style.display = 'none'; return; } if (!nameInput) return; const categoryName = nameInput.value.toLowerCase(); row.style.display = categoryName.includes(searchTerm) ? '' : 'none'; });
      }
      // Activity Log State
      let activityLogData = [];
      let expandedRows = new Set(); // Track which date rows are expanded
      
      // Add event listeners for Activity Log
      function initializeActivityLog() {
        document.getElementById('load-log-btn').addEventListener('click', loadActivityLog);
        document.getElementById('add-log-entry-btn').addEventListener('click', showAddEntryModal);
        document.getElementById('entry-cancel-btn').addEventListener('click', hideEntryModal);
        document.getElementById('entry-form').addEventListener('submit', handleSaveEntry);
        
        // Event delegation for dynamically added elements
        document.getElementById('activity-log-body').addEventListener('click', function(e) {
          if (e.target.classList.contains('delete-activity-btn')) {
            handleDeleteActivity(e);
          } else if (e.target.classList.contains('edit-activity-btn')) {
            handleEditActivity(e);
          }
        });
      }
      
      // Format date for display
      function formatDisplayDate(dateString) {
        const date = new Date(dateString + 'T00:00:00');
        return date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
      }
      
      // Load the activity log data
      function loadActivityLog() {
        const logBody = document.getElementById('activity-log-body');
        logBody.innerHTML = '<tr><td colspan="4">Loading activity log...</td></tr>';
        
        document.getElementById('load-log-btn').disabled = true;
        
        google.script.run
          .withSuccessHandler(handleLogData)
          .withFailureHandler(function(error) {
            handleError(error);
            logBody.innerHTML = `<tr><td colspan="4">Error loading log: ${error.message || 'Unknown error'}</td></tr>`;
            document.getElementById('load-log-btn').disabled = false;
          })
          .getRecentActivityLog();
      }
      
      // Handle log data returned from server
      function handleLogData(result) {
        document.getElementById('load-log-btn').disabled = false;
        
        if (result.success) {
          activityLogData = result.log || [];
          renderActivityLogTable();
        } else {
          showNotification('Error: ' + (result.message || 'Failed to load activity log'), true);
          document.getElementById('activity-log-body').innerHTML = 
            `<tr><td colspan="4">Error: ${result.message || 'Failed to load activity log'}</td></tr>`;
        }
      }
      
      // Render the activity log table grouped by date
      function renderActivityLogTable() {
        const logBody = document.getElementById('activity-log-body');
        logBody.innerHTML = '';
        
        if (!activityLogData || activityLogData.length === 0) {
          logBody.innerHTML = '<tr><td colspan="4">No recent activity found in the last 7 days</td></tr>';
          return;
        }
        
        // Group by date
        const groupedByDate = {};
        activityLogData.forEach(entry => {
          if (!groupedByDate[entry.date]) {
            groupedByDate[entry.date] = [];
          }
          groupedByDate[entry.date].push(entry);
        });
        
        // Sort dates newest first
        const sortedDates = Object.keys(groupedByDate).sort((a, b) => b.localeCompare(a));
        
        sortedDates.forEach(date => {
          const entries = groupedByDate[date];
          
          // Create a row for each date
          entries.forEach((entry) => {
            // For each user/date row
            const dateRow = document.createElement('tr');
            dateRow.className = 'date-row';
            dateRow.dataset.date = date;
            dateRow.dataset.email = entry.email;
            
            // Get the individual activities
            const activities = entry.activities || [];
            
            // Date cell
            const dateCell = document.createElement('td');
            dateCell.textContent = formatDisplayDate(date);
            
            // Email cell
            const emailCell = document.createElement('td');
            emailCell.textContent = entry.email;
            
            // Activities cell - create a list of individual activities
            const activitiesCell = document.createElement('td');
            
            if (activities.length > 0) {
              const activitiesList = document.createElement('ul');
              activitiesList.style.paddingLeft = '20px';
              activitiesList.style.margin = '0';
              
              activities.forEach(activity => {
                const activityItem = document.createElement('li');
                activityItem.style.margin = '5px 0';
                activityItem.style.display = 'flex';
                activityItem.style.justifyContent = 'space-between';
                activityItem.style.alignItems = 'center';
                
                // Create activity text with symbol and points
                const activityText = document.createElement('span');
                activityText.innerHTML = `${activity.symbol} ${activity.name} (${activity.points >= 0 ? '+' : ''}${activity.points})`;
                if (activity.streakInfo) {
                  activityText.innerHTML += ` ${activity.streakInfo}`;
                }
                activityItem.appendChild(activityText);
                
                // Create activity actions
                const activityActions = document.createElement('span');
                activityActions.style.display = 'flex';
                activityActions.style.gap = '5px';
                
                // Edit button for this activity
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary btn-sm edit-activity-btn';
                editBtn.innerHTML = '✎';
                editBtn.title = 'Edit Activity';
                editBtn.dataset.rowIndex = entry.rowIndex;
                editBtn.dataset.activityId = activity.id;
                editBtn.dataset.date = date;
                editBtn.dataset.email = entry.email;
                editBtn.dataset.activityName = activity.name;
                activityActions.appendChild(editBtn);
                
                // Delete button for this activity
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm delete-activity-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.title = 'Delete Activity';
                deleteBtn.dataset.rowIndex = entry.rowIndex;
                deleteBtn.dataset.activityId = activity.id;
                deleteBtn.dataset.date = date;
                deleteBtn.dataset.email = entry.email;
                deleteBtn.dataset.activityName = activity.name;
                activityActions.appendChild(deleteBtn);
                
                activityItem.appendChild(activityActions);
                activitiesList.appendChild(activityItem);
              });
              
              activitiesCell.appendChild(activitiesList);
            } else {
              activitiesCell.textContent = 'No activities found';
            }
            
            // Actions cell for the whole row
            const actionsCell = document.createElement('td');
            
            // Add Activity button for this date/email
            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-primary btn-sm';
            addBtn.innerHTML = '+';
            addBtn.title = 'Add Activity';
            addBtn.dataset.date = date;
            addBtn.dataset.email = entry.email;
            addBtn.addEventListener('click', function() {
              showAddEntryModal(date, entry.email);
            });
            actionsCell.appendChild(addBtn);
            
            // Assemble the row
            dateRow.appendChild(dateCell);
            dateRow.appendChild(emailCell);
            dateRow.appendChild(activitiesCell);
            dateRow.appendChild(actionsCell);
            
            // Add to table
            logBody.appendChild(dateRow);
          });
        });
      }
      
      // Show the add entry modal
      function showAddEntryModal(date, email) {
        document.getElementById('entry-modal-title').textContent = 'Add Manual Entry';
        
        // Set date and email if provided (for adding to existing date/user)
        if (date) {
          document.getElementById('entry-date').value = date;
          document.getElementById('entry-date').disabled = true; // Lock the date
        } else {
          // Set today's date as default
          const today = new Date();
          const formattedDate = today.toISOString().split('T')[0]; // YYYY-MM-DD
          document.getElementById('entry-date').value = formattedDate;
          document.getElementById('entry-date').disabled = false;
        }
        
        if (email) {
          document.getElementById('entry-email').value = email;
          document.getElementById('entry-email').disabled = true; // Lock the email
        } else {
          document.getElementById('entry-email').value = '';
          document.getElementById('entry-email').disabled = false;
        }
        
        // Populate activity dropdown
        populateActivityDropdown();
        document.getElementById('entry-activity').value = ''; // Clear selection
        
        // Show the modal
        document.getElementById('add-entry-modal').style.display = 'block';
      }
      
      // Handle editing an activity
      function handleEditActivity(event) {
        const button = event.target;
        const activityId = button.dataset.activityId;
        const rowIndex = parseInt(button.dataset.rowIndex);
        const date = button.dataset.date;
        const email = button.dataset.email;
        const activityName = button.dataset.activityName;
        
        // Set modal title for edit
        document.getElementById('entry-modal-title').textContent = 'Edit Activity';
        
        // Set form values
        document.getElementById('entry-date').value = date;
        document.getElementById('entry-date').disabled = true; // Lock the date
        
        document.getElementById('entry-email').value = email;
        document.getElementById('entry-email').disabled = true; // Lock the email
        
        // Store edit data for submission
        document.getElementById('entry-form').dataset.isEdit = 'true';
        document.getElementById('entry-form').dataset.activityId = activityId;
        document.getElementById('entry-form').dataset.rowIndex = rowIndex;
        
        // Populate activity dropdown and select current activity
        populateActivityDropdown();
        document.getElementById('entry-activity').value = activityName;
        
        // Show the modal
        document.getElementById('add-entry-modal').style.display = 'block';
      }
      
      // Handle deleting an activity
      function handleDeleteActivity(event) {
        const button = event.target;
        const activityId = button.dataset.activityId;
        const rowIndex = parseInt(button.dataset.rowIndex);
        const date = button.dataset.date;
        const email = button.dataset.email;
        const activityName = button.dataset.activityName;
        
        if (confirm(`Are you sure you want to delete "${activityName}" for ${email} on ${formatDisplayDate(date)}?`)) {
          // Disable button during deletion
          button.disabled = true;
          
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                showNotification(result.message);
                loadActivityLog(); // Refresh the log
              } else {
                showNotification('Error: ' + (result.message || 'Failed to delete activity'), true);
                button.disabled = false;
              }
            })
            .withFailureHandler(function(error) {
              handleError(error);
              button.disabled = false;
            })
            .deleteIndividualActivityEntry(rowIndex, activityId, date, email);
        }
      }
      
      // Hide the entry modal
      function hideEntryModal() {
        document.getElementById('add-entry-modal').style.display = 'none';
        // Reset the edit state
        document.getElementById('entry-form').dataset.isEdit = 'false';
        document.getElementById('entry-form').dataset.activityId = '';
        document.getElementById('entry-form').dataset.rowIndex = '';
        // Re-enable inputs that might have been disabled
        document.getElementById('entry-date').disabled = false;
        document.getElementById('entry-email').disabled = false;
      }
      
      // Populate activity dropdown from activitiesData
      function populateActivityDropdown() {
        const select = document.getElementById('entry-activity');
        select.innerHTML = '<option value="">Select an activity...</option>';
        
        if (!activitiesData || activitiesData.length === 0) {
          select.innerHTML += '<option disabled>No activities found</option>';
          return;
        }
        
        // Sort activities by category and then by name
        const sortedActivities = [...activitiesData].sort((a, b) => {
          if (a.category === b.category) {
            return a.activity.localeCompare(b.activity);
          }
          return a.category.localeCompare(b.category);
        });
        
        let currentCategory = null;
        let optgroup = null;
        
        sortedActivities.forEach(activity => {
          // If we're on a new category, create an optgroup
          if (activity.category !== currentCategory) {
            currentCategory = activity.category;
            optgroup = document.createElement('optgroup');
            optgroup.label = currentCategory;
            select.appendChild(optgroup);
          }
          
          const option = document.createElement('option');
          option.value = activity.activity;
          const pointsSign = activity.points >= 0 ? '+' : '';
          option.textContent = `${activity.activity} (${pointsSign}${activity.points})`;
          optgroup.appendChild(option);
        });
      }
      
      // Handle form submission
      function handleSaveEntry(event) {
        event.preventDefault();
        
        const dateInput = document.getElementById('entry-date');
        const emailInput = document.getElementById('entry-email');
        const activityInput = document.getElementById('entry-activity');
        
        // Validate inputs
        if (!dateInput.value || !emailInput.value || !activityInput.value) {
          showNotification('Please fill in all fields', true);
          return;
        }
        
        // Disable buttons during save operation
        document.getElementById('entry-save-btn').disabled = true;
        document.getElementById('entry-cancel-btn').disabled = true;
        
        const isEdit = document.getElementById('entry-form').dataset.isEdit === 'true';
        
        if (isEdit) {
          // Handle edit case - calls the server to edit the activity
          const activityId = document.getElementById('entry-form').dataset.activityId;
          const rowIndex = parseInt(document.getElementById('entry-form').dataset.rowIndex);
          
          google.script.run
            .withSuccessHandler(function(result) {
              document.getElementById('entry-save-btn').disabled = false;
              document.getElementById('entry-cancel-btn').disabled = false;
              
              if (result.success) {
                showNotification(result.message);
                hideEntryModal();
                loadActivityLog(); // Refresh the log
              } else {
                showNotification('Error: ' + (result.message || 'Failed to edit activity'), true);
              }
            })
            .withFailureHandler(function(error) {
              handleError(error);
              document.getElementById('entry-save-btn').disabled = false;
              document.getElementById('entry-cancel-btn').disabled = false;
            })
            .editActivityEntry(rowIndex, activityId, dateInput.value, emailInput.value, activityInput.value);
        } else {
          // Handle add case - calls the server to add a new activity
          google.script.run
            .withSuccessHandler(function(result) {
              document.getElementById('entry-save-btn').disabled = false;
              document.getElementById('entry-cancel-btn').disabled = false;
              
              if (result.success) {
                showNotification(result.message);
                hideEntryModal();
                loadActivityLog(); // Refresh the log
              } else {
                showNotification('Error: ' + (result.message || 'Failed to add activity'), true);
              }
            })
            .withFailureHandler(function(error) {
              handleError(error);
              document.getElementById('entry-save-btn').disabled = false;
              document.getElementById('entry-cancel-btn').disabled = false;
            })
            .addActivityEntry(dateInput.value, emailInput.value, activityInput.value);
        }
      }
      
      // --- Goal Management Functions ---
      
      function refreshGoals() {
        console.log('[ADMIN GOALS DEBUG] Manual refresh goals triggered');
        
        // Show loading state
        const tbody = document.getElementById('goals-body');
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; color: #666; padding: 30px;">
              <div style="margin-bottom: 10px;">🔄 Refreshing goals...</div>
              <div style="font-size: 0.9em; color: #999;">Fetching latest goal data</div>
            </td>
          </tr>
        `;
        
        // Reload goals data
        google.script.run
          .withSuccessHandler(function(goals) {
            console.log('[ADMIN GOALS DEBUG] Manual refresh completed:', goals);
            handleGoalsData(goals);
            showNotification('Goals refreshed successfully');
          })
          .withFailureHandler(function(error) {
            console.log('[ADMIN GOALS DEBUG] Manual refresh failed:', error);
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align: center; color: #ea4335; padding: 30px;">
                  <div style="margin-bottom: 10px;">⚠️ Refresh failed</div>
                  <div style="font-size: 0.9em; color: #666;">
                    ${error.message || 'Unknown error occurred'}
                  </div>
                  <div style="margin-top: 10px;">
                    <button class="btn btn-primary btn-sm" onclick="refreshGoals()">Try Again</button>
                  </div>
                </td>
              </tr>
            `;
            handleError(error);
          })
          .getGoalsData();
      }
      
      function addNewGoal() {
        document.getElementById('goal-modal-title').textContent = 'Add New Goal';
        document.getElementById('goal-form').reset();
        document.getElementById('goal-modal').style.display = 'block';
      }
      
      function closeGoalModal() {
        document.getElementById('goal-modal').style.display = 'none';
      }
      
      function handleGoalSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const goalData = {
          goalName: document.getElementById('goal-name').value,
          goalType: document.getElementById('goal-type').value,
          targetAmount: parseFloat(document.getElementById('goal-target').value),
          currentAmount: parseFloat(document.getElementById('goal-current').value),
          targetDate: document.getElementById('goal-target-date').value || null
        };
        
        // Add to goals data array
        goalsData.push({
          ...goalData,
          goalId: 'new_' + Date.now(),
          status: 'active',
          isNew: true
        });
        
        renderGoalsTable();
        closeGoalModal();
        showNotification('Goal added successfully');
      }
      
      function renderGoalsTable() {
        console.log('[ADMIN GOALS DEBUG] renderGoalsTable called');
        console.log('[ADMIN GOALS DEBUG] goalsData length:', goalsData.length);
        console.log('[ADMIN GOALS DEBUG] goalsData contents:', goalsData);
        
        const tbody = document.getElementById('goals-body');
        
        if (goalsData.length === 0) {
          console.log('[ADMIN GOALS DEBUG] No goals found, showing "No goals configured" message');
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; color: #666; padding: 30px;">
                <div style="margin-bottom: 10px;">📋 No goals configured</div>
                <div style="font-size: 0.9em; color: #999;">
                  Click "Add New Goal" above to create your first goal
                </div>
              </td>
            </tr>
          `;
          return;
        }
        
        console.log('[ADMIN GOALS DEBUG] Rendering', goalsData.length, 'goals');
        
        tbody.innerHTML = goalsData.map(goal => {
          const progress = calculateProgress(goal);
          const progressBar = `
            <div style="background: #f0f0f0; border-radius: 10px; height: 20px; overflow: hidden;">
              <div style="background: ${getProgressColor(goal.goalType, progress)}; height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
            </div>
            <small>${progress}%</small>
          `;
          
          return `
            <tr data-goal-id="${goal.goalId}">
              <td><input type="text" value="${goal.goalName}" onchange="updateGoalField('${goal.goalId}', 'goalName', this.value)"></td>
              <td>
                <select onchange="updateGoalField('${goal.goalId}', 'goalType', this.value)">
                  <option value="debt" ${goal.goalType === 'debt' ? 'selected' : ''}>Debt</option>
                  <option value="savings" ${goal.goalType === 'savings' ? 'selected' : ''}>Savings</option>
                  <option value="vacation_fund" ${goal.goalType === 'vacation_fund' ? 'selected' : ''}>Vacation Fund</option>
                </select>
              </td>
              <td><input type="number" value="${goal.targetAmount}" step="0.01" onchange="updateGoalField('${goal.goalId}', 'targetAmount', parseFloat(this.value))"></td>
              <td><input type="number" value="${goal.currentAmount}" step="0.01" onchange="updateGoalField('${goal.goalId}', 'currentAmount', parseFloat(this.value))"></td>
              <td style="text-align: center;">${progressBar}</td>
              <td>
                <select onchange="updateGoalField('${goal.goalId}', 'status', this.value)">
                  <option value="active" ${goal.status === 'active' ? 'selected' : ''}>Active</option>
                  <option value="completed" ${goal.status === 'completed' ? 'selected' : ''}>Completed</option>
                  <option value="paused" ${goal.status === 'paused' ? 'selected' : ''}>Paused</option>
                  <option value="cancelled" ${goal.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
              </td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="deleteGoal('${goal.goalId}')">Delete</button>
              </td>
            </tr>
          `;
        }).join('');
      }
      
      function updateGoalField(goalId, field, value) {
        const goal = goalsData.find(g => g.goalId === goalId);
        if (goal) {
          goal[field] = value;
          goal.isModified = true;
          // Re-render to update progress if amounts changed
          if (field === 'targetAmount' || field === 'currentAmount') {
            renderGoalsTable();
          }
        }
      }
      
      function deleteGoal(goalId) {
        if (confirm('Are you sure you want to delete this goal?')) {
          goalsData = goalsData.filter(g => g.goalId !== goalId);
          renderGoalsTable();
        }
      }
      
      function calculateProgress(goal) {
        if (!goal.targetAmount || goal.targetAmount <= 0) return 0;
        
        switch (goal.goalType) {
          case 'debt':
            const debtProgress = ((goal.targetAmount - goal.currentAmount) / goal.targetAmount) * 100;
            return Math.max(0, Math.min(100, Math.round(debtProgress)));
          case 'savings':
          case 'vacation_fund':
            const savingsProgress = (goal.currentAmount / goal.targetAmount) * 100;
            return Math.max(0, Math.min(100, Math.round(savingsProgress)));
          default:
            return 0;
        }
      }
      
      function getProgressColor(goalType, progress) {
        if (progress >= 100) return '#34A853'; // Green for completed
        if (progress >= 75) return '#FBBC05'; // Yellow for near completion
        if (goalType === 'debt') return '#EA4335'; // Red for debt
        return '#4285F4'; // Blue for savings/vacation
      }
      
      function filterGoals() {
        const searchTerm = document.getElementById('search-goals').value.toLowerCase();
        const rows = document.querySelectorAll('#goals-body tr');
        
        rows.forEach(row => {
          const goalName = row.cells[0]?.textContent.toLowerCase() || '';
          const goalType = row.cells[1]?.textContent.toLowerCase() || '';
          const visible = goalName.includes(searchTerm) || goalType.includes(searchTerm);
          row.style.display = visible ? '' : 'none';
        });
      }
      
      function resetGoals() {
        goalsData = [...originalGoalsData];
        renderGoalsTable();
        showNotification('Goals reset to original values');
      }
      
      function saveGoals() {
        const modifiedGoals = goalsData.filter(g => g.isModified || g.isNew);
        const deletedGoals = originalGoalsData.filter(og => !goalsData.find(g => g.goalId === og.goalId));
        
        if (modifiedGoals.length === 0 && deletedGoals.length === 0) {
          showNotification('No changes to save');
          return;
        }
        
        showNotification('Saving goals...');
        
        google.script.run
          .withSuccessHandler(handleGoalsSaved)
          .withFailureHandler(handleError)
          .saveGoalsData(modifiedGoals, deletedGoals);
      }
      
      function handleGoalsSaved(result) {
        if (result.success) {
          showNotification('Goals saved successfully');
          // Refresh goals data immediately after saving
          console.log('[ADMIN GOALS DEBUG] Reloading goals after successful save...');
          google.script.run
            .withSuccessHandler(function(goals) {
              console.log('[ADMIN GOALS DEBUG] Reloaded goals after save:', goals);
              handleGoalsData(goals);
            })
            .withFailureHandler(function(error) {
              console.log('[ADMIN GOALS DEBUG] Error reloading goals after save:', error);
              handleError(error);
            })
            .getGoalsData();
        } else {
          showNotification('Error saving goals: ' + result.message);
        }
      }
      
      function handleGoalsData(goals) {
        console.log('[ADMIN GOALS DEBUG] handleGoalsData called with:', goals);
        console.log('[ADMIN GOALS DEBUG] Type of goals parameter:', typeof goals);
        console.log('[ADMIN GOALS DEBUG] Is goals array?', Array.isArray(goals));
        
        if (goals) {
          console.log('[ADMIN GOALS DEBUG] Goals length:', goals.length);
          if (goals.length > 0) {
            console.log('[ADMIN GOALS DEBUG] First goal structure:', goals[0]);
          }
        }
        
        // Convert date strings back to Date objects if needed and ensure proper data structure
        let processedGoals = [];
        if (Array.isArray(goals)) {
          processedGoals = goals.map(goal => {
            if (typeof goal === 'object' && goal !== null) {
              const processedGoal = {...goal};
              
              // Convert ISO date strings back to Date objects for local processing if needed
              if (processedGoal.startDate && typeof processedGoal.startDate === 'string') {
                try {
                  processedGoal.startDate = new Date(processedGoal.startDate);
                } catch (e) {
                  console.warn('[ADMIN GOALS DEBUG] Could not parse startDate:', processedGoal.startDate);
                }
              }
              
              if (processedGoal.targetDate && typeof processedGoal.targetDate === 'string') {
                try {
                  processedGoal.targetDate = new Date(processedGoal.targetDate);
                } catch (e) {
                  console.warn('[ADMIN GOALS DEBUG] Could not parse targetDate:', processedGoal.targetDate);
                }
              }
              
              if (processedGoal.lastUpdated && typeof processedGoal.lastUpdated === 'string') {
                try {
                  processedGoal.lastUpdated = new Date(processedGoal.lastUpdated);
                } catch (e) {
                  console.warn('[ADMIN GOALS DEBUG] Could not parse lastUpdated:', processedGoal.lastUpdated);
                }
              }
              
              return processedGoal;
            }
            return goal;
          });
        }
        
        goalsData = processedGoals;
        console.log('[ADMIN GOALS DEBUG] Set goalsData to array of length:', goalsData.length);
        
        originalGoalsData = JSON.parse(JSON.stringify(goalsData));
        renderGoalsTable();
      }

      // --- BUDGET CATEGORY MANAGEMENT FUNCTIONS ---
      
      function handleBudgetCategoriesData(data) {
        console.log('[ADMIN BUDGET DEBUG] handleBudgetCategoriesData called with:', data);
        
        if (data.success && data.budgetCategories) {
          budgetCategoriesData = data.budgetCategories.categories || [];
          console.log('[ADMIN BUDGET DEBUG] Loaded budget categories:', budgetCategoriesData.length);
          originalBudgetCategoriesData = JSON.parse(JSON.stringify(budgetCategoriesData));
          renderBudgetCategoriesTable();
        } else {
          console.log('[ADMIN BUDGET DEBUG] No budget categories data or error:', data.message);
          const tbody = document.getElementById('budget-categories-body');
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; color: #666; padding: 30px;">
                <div style="margin-bottom: 10px;">No budget categories found</div>
                <div style="font-size: 0.9em; color: #999;">Click "Add New Category" to create your first budget category</div>
              </td>
            </tr>
          `;
        }
      }

      function renderBudgetCategoriesTable() {
        const tbody = document.getElementById('budget-categories-body');
        
        if (!budgetCategoriesData || budgetCategoriesData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; color: #666; padding: 30px;">
                <div style="margin-bottom: 10px;">No budget categories found</div>
                <div style="font-size: 0.9em; color: #999;">Click "Add New Category" to create your first budget category</div>
              </td>
            </tr>
          `;
          return;
        }

        const rows = budgetCategoriesData.map((category, index) => {
          const percentUsed = category.payPeriodBudget > 0 ? (category.payPeriodSpent / category.payPeriodBudget) * 100 : 0;
          let statusClass = 'good';
          let statusText = 'Good';
          
          if (percentUsed > 90) {
            statusClass = 'danger';
            statusText = 'Over Budget';
          } else if (percentUsed > 75) {
            statusClass = 'warning';
            statusText = 'Near Limit';
          }

          return `
            <tr data-index="${index}">
              <td>
                <input type="text" value="${category.name}" data-field="name" 
                       style="border: 1px solid #ddd; padding: 4px; width: 100%;">
              </td>
              <td>
                <input type="number" value="${category.monthlyBudget}" data-field="monthlyBudget" 
                       step="0.01" min="0" style="border: 1px solid #ddd; padding: 4px; width: 100%;">
              </td>
              <td>
                <input type="number" value="${category.payPeriodBudget}" data-field="payPeriodBudget" 
                       step="0.01" min="0" style="border: 1px solid #ddd; padding: 4px; width: 100%;">
              </td>
              <td style="text-align: right; color: #ea4335;">
                $${category.payPeriodSpent.toFixed(2)}
              </td>
              <td style="text-align: right; color: ${category.remaining >= 0 ? '#34A853' : '#ea4335'};">
                $${category.remaining.toFixed(2)}
              </td>
              <td>
                <span class="status-badge status-${statusClass}" style="
                  padding: 2px 8px; 
                  border-radius: 12px; 
                  font-size: 0.8em; 
                  font-weight: 500;
                  background: ${statusClass === 'danger' ? '#fce8e6' : statusClass === 'warning' ? '#fef7e0' : '#e6f4ea'};
                  color: ${statusClass === 'danger' ? '#d93025' : statusClass === 'warning' ? '#f9ab00' : '#34a853'};
                ">${statusText}</span>
              </td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="removeBudgetCategory(${index})" 
                        title="Delete Category">🗑️</button>
              </td>
            </tr>
          `;
        }).join('');

        tbody.innerHTML = rows;
        addBudgetCategoryInputListeners();
      }

      function addBudgetCategoryInputListeners() {
        const inputs = document.querySelectorAll('#budget-categories-table input');
        inputs.forEach(input => {
          input.addEventListener('input', (e) => {
            const row = e.target.closest('tr');
            const index = parseInt(row.dataset.index);
            const field = e.target.dataset.field;
            const value = e.target.type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value;
            
            if (budgetCategoriesData[index]) {
              budgetCategoriesData[index][field] = value;
              
              // Recalculate remaining amount if budget changed
              if (field === 'payPeriodBudget') {
                budgetCategoriesData[index].remaining = value - budgetCategoriesData[index].payPeriodSpent;
                budgetCategoriesData[index].percentUsed = value > 0 ? (budgetCategoriesData[index].payPeriodSpent / value) * 100 : 0;
              }
            }
          });
        });
      }

      function addNewBudgetCategory() {
        document.getElementById('budget-category-modal-title').textContent = 'Add New Budget Category';
        document.getElementById('budget-category-form').reset();
        document.getElementById('budget-category-modal').style.display = 'block';
      }

      function closeBudgetCategoryModal() {
        document.getElementById('budget-category-modal').style.display = 'none';
      }

      function handleBudgetCategorySubmit(e) {
        e.preventDefault();
        
        const name = document.getElementById('budget-category-name').value;
        const monthlyBudget = parseFloat(document.getElementById('budget-monthly-budget').value) || 0;
        const payPeriodBudget = parseFloat(document.getElementById('budget-pay-period-budget').value) || 0;
        const currentSpent = parseFloat(document.getElementById('budget-current-spent').value) || 0;

        const newCategory = {
          name: name,
          monthlyBudget: monthlyBudget,
          currentSpent: currentSpent,
          payPeriodBudget: payPeriodBudget,
          payPeriodSpent: currentSpent,
          lastReset: new Date(),
          householdId: null,
          remaining: payPeriodBudget - currentSpent,
          percentUsed: payPeriodBudget > 0 ? (currentSpent / payPeriodBudget) * 100 : 0,
          isActive: true
        };

        budgetCategoriesData.push(newCategory);
        renderBudgetCategoriesTable();
        closeBudgetCategoryModal();
        showNotification('Budget category added successfully');
      }

      function removeBudgetCategory(index) {
        const category = budgetCategoriesData[index];
        if (confirm(`Are you sure you want to delete the "${category.name}" budget category?`)) {
          budgetCategoriesData.splice(index, 1);
          renderBudgetCategoriesTable();
          showNotification('Budget category deleted');
        }
      }

      function refreshBudgetCategories() {
        console.log('[ADMIN BUDGET DEBUG] Refreshing budget categories...');
        google.script.run
          .withSuccessHandler(handleBudgetCategoriesData)
          .withFailureHandler(handleError)
          .getExpenseTrackerData();
      }

      function resetBudgetCategories() {
        budgetCategoriesData = JSON.parse(JSON.stringify(originalBudgetCategoriesData));
        renderBudgetCategoriesTable();
        showNotification('Budget categories reset to original values');
      }

      function saveBudgetCategories() {
        console.log('[ADMIN BUDGET DEBUG] Saving budget categories:', budgetCategoriesData);
        
        // Disable save button and show loading
        const saveBtn = document.getElementById('save-budget-categories-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        google.script.run
          .withSuccessHandler(function(result) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Budget Categories';
            
            if (result.success) {
              showNotification(result.message, 'success');
              // Update original data to match current
              originalBudgetCategoriesData = JSON.parse(JSON.stringify(budgetCategoriesData));
            } else {
              showNotification('Error saving budget categories: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            console.error('[ADMIN BUDGET DEBUG] Error saving budget categories:', error);
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Budget Categories';
            showNotification('Error saving budget categories: ' + error.message, 'error');
          })
          .saveBudgetCategoriesData(budgetCategoriesData);
      }

      function filterBudgetCategories() {
        const searchTerm = document.getElementById('search-budget-categories').value.toLowerCase();
        const rows = document.querySelectorAll('#budget-categories-table tbody tr');
        
        rows.forEach(row => {
          const categoryName = row.querySelector('input[data-field="name"]')?.value.toLowerCase() || '';
          const isVisible = categoryName.includes(searchTerm);
          row.style.display = isVisible ? '' : 'none';
        });
      }

      // --- END BUDGET CATEGORY MANAGEMENT FUNCTIONS ---

      // Add initialization to document ready function (or at the end of existing script)
      document.addEventListener('DOMContentLoaded', function() {
        // This line likely already exists
        initializeAdmin();
        
        // Add this line to initialize activity log features
        initializeActivityLog();
      });
    </script>
  </body>
</html>